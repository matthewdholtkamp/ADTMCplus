<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>ADTMC+ Medic Sick Call Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, summary, button {
            font-family: 'Roboto Condensed', sans-serif;
            letter-spacing: 0.5px;
        }
        .hidden {
            display: none;
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #F97316; /* Safety Orange */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        details > summary {
            cursor: pointer;
        }

        /* --- NEW: Button Styles --- */
        /* Apply tailwind classes directly for consistency */
        .btn {
            @apply font-semibold py-3 px-6 rounded-md shadow-md transition-all duration-150 transform;
        }
        .btn-primary {
            @apply bg-orange-600 text-white hover:bg-orange-500 hover:shadow-lg hover:-translate-y-0.5;
        }
        .btn-secondary {
            @apply bg-transparent border border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white hover:shadow-lg hover:-translate-y-0.5;
        }
        .btn-back {
            @apply bg-gray-700 text-white hover:bg-gray-600 hover:shadow-lg hover:-translate-y-0.5;
        }
        /* NEW: Style for clickable list items */
        .btn-toggle {
            @apply bg-gray-800 border border-orange-600 rounded-md p-4 transition-all duration-150 cursor-pointer hover:bg-gray-700 hover:shadow-md;
        }
        .btn-toggle label {
            @apply cursor-pointer;
        }
        /* Error Message Box */
        .error-box {
            @apply hidden bg-red-900/50 border border-red-600 text-red-300 p-4 rounded-md mb-4;
        }
    </style>
</head>
<body class="bg-gray-900 text-zinc-200">

    <div class="max-w-2xl mx-auto p-4 sm:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-orange-500">ADTMC +</h1>
            <p class="text-lg text-gray-300">Medic Decision Support Tool</p>
        </header>

        <!-- 
        =======================================================================
        REMOVED: API KEY SECTION
        =======================================================================
        -->

        <!-- 
        =======================================================================
        REMOVED: WRAPPER FOR MAIN APP CONTENT
        =======================================================================
        -->
        
        <!-- 
        =======================================================================
        IMPROVED: CRITICAL DISCLAIMER (Now collapsible)
        =======================================================================
        -->
        <details class="bg-red-900/50 border border-red-600 rounded-md mb-8">
            <summary class="font-semibold text-red-300 p-3 cursor-pointer text-lg">
                Click to Review: De-identified Data Only (HIPAA Warning)
            </summary>
            <div class="p-4 border-t border-red-700">
                <p class="font-bold text-red-200">This tool is for processing **DE-IDENTIFIED DATA ONLY**.</p>
                <p class="text-red-300">You must follow the **two-part** Safe Harbor test below: (1) Remove all 18 identifiers, and (2) Ensure you have no 'actual knowledge' that remaining information (e.g., a unique job, a publicized event) could identify the patient. Entering PHI is a HIPAA violation.</p>
            </div>
        </details>

        <!-- 
        =======================================================================
        LOADING SPINNER
        =======================================================================
        -->
        <div id="loading-spinner" class="hidden flex justify-center items-center p-8">
            <div class="spinner"></div>
            <p class="ml-4 text-lg font-semibold text-gray-300">Processing...</p>
        </div>

        <!-- 
        =======================================================================
        SECTION 1: CHIEF COMPLAINT
        =======================================================================
        -->
        <div id="section-symptoms" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
            <!-- Safe Harbor Guide -->
            <details class="bg-amber-900/50 border border-amber-600 rounded-md mb-6">
                <summary class="font-semibold text-amber-300 p-3 cursor-pointer text-lg">
                    Click to Review: 2-Part De-identification Guide
                </summary>
                <div class="p-4 border-t border-amber-700">
                    <p class="text-sm text-gray-300 mb-2">You MUST remove all of the following to meet the Safe Harbor standard.</p>
                    <h4 class="font-semibold text-lg mb-2 text-gray-200">Part 1: The 18 Identifiers</h4>
                    <ol class="list-decimal list-inside text-sm space-y-1 text-gray-400">
                        <li>Names</li>
                        <li>All geographic subdivisions smaller than a State (e.g., zip code, city, county)</li>
                        <li>All elements of dates (except year)</li>
                        <li>Ages over 89</li>
                        <li>Telephone numbers</li>
                        <li>Fax numbers</li>
                        <li>Email addresses</li>
                        <li>Social Security numbers</li>
                        <li>Medical record numbers</li>
                        <li>Health plan beneficiary numbers</li>
                        <li>Account numbers</li>
                        <li>Certificate/license numbers</li>
                        <li>Vehicle identifiers (including license plates)</li>
                        <li>Device identifiers and serial numbers</li>
                        <li>Web URLs</li>
                        <li>IP addresses</li>
                        <li>Biometric identifiers (fingerprints, voice prints)</li>
                        <li>Full face photographs</li>
                    </ol>
                    <h4 class="font-semibold text-lg mt-4 mb-2 text-gray-200">Part 2: The "Actual Knowledge" Clause</h4>
                    <p class="text-sm text-gray-300">You must also remove any other information you know could identify the person. Even if not in the list, a unique identifier is still PHI.</p>
                    <p class="text-sm font-semibold text-gray-300 mt-2">Examples of Violations:</p>
                    <ul class="list-disc list-inside text-sm text-red-400">
                        <li>"The post Command Sergeant Major..." (Unique job)</li>
                        <li>"The president of the state university..." (Unique job)</li>
                        <li>"A patient involved in the highly publicized local news event..." (Unique event)</li>
                    </ul>
                </div>
            </details>
            
            <h2 class="text-xl font-semibold mb-4">1. De-identified Chief Complaint</h2>

            <div id="error-message-symptoms" class="error-box"></div>

            <form id="symptom-form">
                <label for="initial-symptoms" class="block text-sm font-medium text-gray-300 mb-1">Enter the de-identified chief complaint:</label>
                <textarea id="initial-symptoms" rows="3" class="w-full p-2 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white" placeholder="e.g., A soldier in their 20s with acute-on-chronic low back pain..."></textarea>
                
                <button type="button" id="example-complaint-btn" class="mt-2 text-sm text-gray-400 hover:underline">Use example: "20ish soldier with lower back pain for one week"</button>
                
                <button type="submit" class="mt-4 w-full btn btn-primary flex items-center justify-center">
                    Begin Intake
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </form>
        </div>


        <!-- 
        =======================================================================
        SECTION 2: AI-GUIDED INTAKE QUESTIONS
        =======================================================================
        -->
        <div id="section-questions" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">2. Guided Intake Questions</h2>
            <p class="text-sm text-gray-400 mb-4">Ask the patient these follow-up questions and record their de-identified answers.</p>
            
            <div id="error-message-questions" class="error-box"></div>

            <form id="questions-form">
                <div id="questions-container" class="space-y-4">
                    <!-- AI questions will be injected here -->
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                    <button type="button" id="questions-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        Back
                    </button>
                    <button type="submit" class="flex-1 btn btn-primary flex items-center justify-center">
                        Continue to History
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </form>
        </div>

        <!-- 
        =======================================================================
        NEW: SECTION 3: PATIENT HISTORY
        =======================================================================
        -->
        <div id="section-history" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">3. Patient History</h2>
            <p class="text-sm text-gray-400 mb-4">Record the patient's past medical history, allergies, and current medications.</p>
            
            <div id="error-message-history" class="error-box"></div>

            <form id="history-form" class="space-y-4">
                <div>
                    <label for="pmh-input" class="block text-sm font-medium text-gray-300 mb-1">Past Medical History (PMH):</label>
                    <textarea id="pmh-input" rows="3" class="w-full p-2 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white" placeholder="e.g., HTN, GERD, anxiety, past left ankle sprain. No surgeries."></textarea>
                </div>
                <div>
                    <label for="allergies-input" class="block text-sm font-medium text-gray-300 mb-1">Allergies:</label>
                    <textarea id="allergies-input" rows="2" class="w-full p-2 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white" placeholder="e.g., NKDA, Penicillin (rash), seasonal."></textarea>
                </div>
                <div>
                    <label for="meds-input" class="block text-sm font-medium text-gray-300 mb-1">Current Medications:</label>
                    <textarea id="meds-input" rows="3" class="w-full p-2 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white" placeholder="e.g., Lisinopril 10mg daily, Omeprazole 20mg daily, Trazodone 50mg nightly."></textarea>
                </div>

                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 pt-4">
                    <button type="button" id="history-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        Back
                    </button>
                    <button type="submit" id="history-continue-btn" class="flex-1 btn btn-primary flex items-center justify-center">
                        Finalize HPI / Generate Plan
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </form>
        </div>

        <!-- 
        =======================================================================
        SECTION 4: RECOMMENDED DIAGNOSTICS (Renumbered)
        =======================================================================
        -->
        <div id="section-imaging" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            
            <div id="emergency-alert" class="hidden bg-red-900/50 border-l-4 border-red-600 text-red-300 p-4 rounded-md mb-6" role="alert">
                <p class="font-bold">Urgent Triage Recommendation</p>
                <p>The AI suggests this case may be an emergency requiring immediate ER triage.</p>
                <p id="emergency-reason" class="mt-2">Reasoning will be loaded here.</p>
            </div>

            <h2 class="text-xl font-semibold mb-4">4. Recommended Diagnostics</h2>
            <p class="text-sm text-gray-400 mb-4">Review the AI-suggested diagnostics and select those that are indicated.</p>
            
            <div id="error-message-imaging" class="error-box"></div>

            <div id="imaging-list-container" class="space-y-3">
                <!-- AI-generated imaging will be injected here -->
            </div>
            <div id="no-imaging-message" class="hidden text-gray-400">
                No specific imaging or diagnostics are recommended by the AI.
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                <button type="button" id="imaging-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                    Back
                </button>
                <button type="button" id="imaging-continue-btn" class="flex-1 btn btn-primary flex items-center justify-center">
                    Proceed to Meds
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>


        <!-- 
        =======================================================================
        SECTION 5: RECOMMENDED MEDICATIONS (Renumbered)
        =======================================================================
        -->
        <div id="section-medication" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">5. Recommended Medications</h2>
            <p class="text-sm text-gray-400 mb-4">Review the AI-suggested medications and select those you wish to include in the plan.</p>
            
            <div id="error-message-medication" class="error-box"></div>

            <div id="medication-list-container" class="space-y-3">
                <!-- AI-generated medications will be injected here -->
            </div>
            <div id="no-meds-message" class="hidden text-gray-400">
                No specific medications are recommended by the AI.
            </div>
            <div class="flex flex-col space-y-2 mt-6">
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button type="button" id="medication-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                            Back
                        </button>
                    <button type="button" id="medication-continue-btn" class="flex-1 btn btn-primary flex items-center justify-center">
                        Proceed to Consults
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 
        =======================================================================
        SECTION 6: RECOMMENDED CONSULTS & EDUCATION (Renumbered)
        =======================================================================
        -->
        <div id="section-consults" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">6. Recommended Consults & Education</h2>
            <p class="text-sm text-gray-400 mb-4">Review the AI-suggested consults and patient education topics and select those to include in the plan.</p>
            
            <div id="error-message-consults" class="error-box"></div>

            <div id="consults-list-container" class="space-y-3">
                <!-- AI-generated consults and education will be injected here -->
            </div>
            <div id="no-consults-message" class="hidden text-gray-400">
                No specific consults or education topics are recommended by the AI.
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                <button type="button" id="consults-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        Back
                    </button>
                <button type="button" id="consults-continue-btn" class="flex-1 btn btn-primary flex items-center justify-center">
                    Proceed to Profile
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>

        <!-- 
        =======================================================================
        SECTION 7: PROFILE RECOMMENDATIONS (Renumbered)
        =======================================================================
        -->
        <div id="section-profile" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">7. Profile Recommendations</h2>
            <p class="text-sm text-gray-400 mb-4">Review the AI-suggested profile. Adjust days and select the limitations and patient instructions to include in the final note.</p>
            
            <div id="error-message-profile" class="error-box"></div>
            
            <div id="profile-recommendations-container" class="space-y-4">
                <!-- AI-generated profile info will be injected here -->
            </div>
            
            <div id="no-profile-message" class="hidden text-gray-400">
                No specific profile recommendations were generated by the AI.
            </div>

            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                <button type="button" id="profile-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        Back
                    </button>
                <button type="button" id="profile-continue-btn" class="flex-1 btn btn-primary flex items-center justify-center">
                    Generate AAR / Note
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>


        <!-- 
        =======================================================================
        SECTION 8: GENERATED CLINICAL NOTE (FOR EHR) (Renumbered)
        =======================================================================
        -->
        <div id="section-provider-note" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">8. Generated Clinical Note (AAR)</h2>
            <p class="text-sm text-gray-400 mb-4">Review the final generated note. Use the button to copy it to your clipboard to paste into an EHR or training log.</p>
            
            <div id="error-message-providerNote" class="error-box"></div>
            
            <div class="bg-gray-900 p-4 rounded-md border border-gray-600 max-h-96 overflow-y-auto">
                <pre id="provider-note-content" class="text-sm text-gray-300 whitespace-pre-wrap font-sans"></pre>
            </div>

            <button type="button" id="copy-note-btn" class="mt-4 w-full btn btn-primary flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                Copy Note to Clipboard
            </button>
            <p id="copy-success" class="hidden mt-4 text-center text-orange-500 font-semibold">Note copied to clipboard!</p>
            
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                <button type="button" id="note-back-btn" class="flex-1 btn btn-back flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        Back to Profile
                </button>
                <button type="button" id="start-over-btn" class="flex-1 btn btn-secondary flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.004 14a1 1 0 01.996-.928A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 005.004 17z" clip-rule="evenodd" /></svg>
                    New Patient
                </button>
            </div>
        </div>
        
    </div> <!-- End of main content div -->

    <script>
        // --- State Management ---
        let intakeState = {
            chiefComplaint: "",
            questions: [],
            answers: [],
            pastMedicalHistory: "",
            allergies: "",
            currentMedications: "",
            hpi: "",
            assessmentAndPlan: "",
            emergencyTriage: null,
            recommendedImaging: [],
            recommendedMeds: [],
            recommendedConsults: [],
            recommendedEducation: [],
            recommendedProfile: {},
            selectedImaging: [],
            selectedMeds: [],
            selectedConsults: [],
            selectedEducation: [],
            selectedProfileDays: 0,
            selectedProfileLimitations: [],
            selectedProfilePatientInfo: []
        };

        // --- DOM Elements ---
        
        // REMOVED: API Key Elements

        const symptomForm = document.getElementById('symptom-form');
        const exampleComplaintBtn = document.getElementById('example-complaint-btn');
        const initialSymptomsEl = document.getElementById('initial-symptoms');
        
        const questionsForm = document.getElementById('questions-form');
        const questionsContainer = document.getElementById('questions-container');
        const questionsBackBtn = document.getElementById('questions-back-btn');

        const historyForm = document.getElementById('history-form');
        const historyBackBtn = document.getElementById('history-back-btn');
        const historyContinueBtn = document.getElementById('history-continue-btn');
        const pmhInput = document.getElementById('pmh-input');
        const allergiesInput = document.getElementById('allergies-input');
        const medsInput = document.getElementById('meds-input');
        
        const imagingContinueBtn = document.getElementById('imaging-continue-btn');
        const imagingBackBtn = document.getElementById('imaging-back-btn');
        const imagingListContainer = document.getElementById('imaging-list-container');
        const noImagingMessage = document.getElementById('no-imaging-message');
        const emergencyAlert = document.getElementById('emergency-alert');
        const emergencyReason = document.getElementById('emergency-reason');

        const medicationContinueBtn = document.getElementById('medication-continue-btn');
        const medicationBackBtn = document.getElementById('medication-back-btn');
        const medicationListContainer = document.getElementById('medication-list-container');
        const noMedsMessage = document.getElementById('no-meds-message');

        const consultsContinueBtn = document.getElementById('consults-continue-btn');
        const consultsBackBtn = document.getElementById('consults-back-btn');
        const consultsListContainer = document.getElementById('consults-list-container');
        const noConsultsMessage = document.getElementById('no-consults-message');

        const profileContinueBtn = document.getElementById('profile-continue-btn');
        const profileBackBtn = document.getElementById('profile-back-btn');
        const profileRecommendationsContainer = document.getElementById('profile-recommendations-container');
        const noProfileMessage = document.getElementById('no-profile-message');

        const providerNoteContent = document.getElementById('provider-note-content');
        const copyNoteBtn = document.getElementById('copy-note-btn');
        const copySuccess = document.getElementById('copy-success');
        const startOverBtn = document.getElementById('start-over-btn');
        const noteBackBtn = document.getElementById('note-back-btn');
        
        const sections = {
            symptoms: document.getElementById('section-symptoms'),
            questions: document.getElementById('section-questions'),
            history: document.getElementById('section-history'),
            imaging: document.getElementById('section-imaging'),
            medication: document.getElementById('section-medication'),
            consults: document.getElementById('section-consults'),
            profile: document.getElementById('section-profile'),
            providerNote: document.getElementById('section-provider-note'),
        };
        const loadingSpinner = document.getElementById('loading-spinner');

        const errorBoxes = {
            // REMOVED: apiKey
            symptoms: document.getElementById('error-message-symptoms'),
            questions: document.getElementById('error-message-questions'),
            history: document.getElementById('error-message-history'),
            imaging: document.getElementById('error-message-imaging'),
            medication: document.getElementById('error-message-medication'),
            consults: document.getElementById('error-message-consults'),
            profile: document.getElementById('error-message-profile'),
            providerNote: document.getElementById('error-message-providerNote'),
        };

        // --- REMOVED: API Key Logic ---
        

        // --- UI Helpers ---

        /**
         * Hides all error boxes
         */
        function clearErrors() {
            Object.values(errorBoxes).forEach(box => {
                box.classList.add('hidden');
                box.textContent = '';
            });
        }

        /**
         * Shows an error message in a specific section's error box.
         * @param {string} sectionId - The key of the section (from `sections` object).
         * @param {string} message - The error message to display.
         */
        function showErrorMessage(sectionId, message) {
            if (errorBoxes[sectionId]) {
                errorBoxes[sectionId].textContent = message;
                errorBoxes[sectionId].classList.remove('hidden');
            }
        }

        /**
         * Shows/hides the main loading spinner and hides all content sections.
         * @param {boolean} isLoading - True to show spinner, false to hide.
         */
        function showLoading(isLoading) {
            clearErrors(); // Clear all errors when loading
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                Object.values(sections).forEach(section => section.classList.add('hidden'));
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Hides all sections and shows only the specified section.
         * Also ensures the loading spinner is hidden.
         * @param {string} sectionId - The key of the section to show (from `sections` object).
         */
        function showSection(sectionId) {
            showLoading(false); // Ensure spinner is off
            Object.keys(sections).forEach(key => {
                if (key === sectionId) {
                    sections[key].classList.remove('hidden');
                } else {
                    sections[key].classList.add('hidden');
                }
            });
            window.scrollTo(0, 0); // Scroll to top
        }

        // --- Render Helpers ---

        function renderQuestions(questions) {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            if (!questions || questions.length === 0) {
                container.innerHTML = '<p class.text-gray-400">No follow-up questions were generated. You can proceed directly.</p>';
                return;
            }
            questions.forEach((q, index) => {
                const qId = `q-answer-${index}`;
                const existingAnswer = intakeState.answers.find(a => a.question === q)?.answer || '';
                const questionHtml = `
                    <div>
                        <label for="${qId}" class="block text-sm font-medium text-gray-300 mb-1">${q}</label>
                        <input type="text" id="${qId}" name="${qId}" data-question="${q}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white" required placeholder="Enter de-identified answer..." value="${existingAnswer}">
                    </div>
                `;
                container.innerHTML += questionHtml;
            });
        }

        function renderImagingList() {
            const container = document.getElementById('imaging-list-container');
            container.innerHTML = '';
            const recommendedImaging = intakeState.recommendedImaging;
            const selectedNames = new Set(intakeState.selectedImaging.map(item => item.name));

            if (!recommendedImaging || recommendedImaging.length === 0) {
                noImagingMessage.classList.remove('hidden');
                return;
            }
            
            noImagingMessage.classList.add('hidden');
            recommendedImaging.forEach((img, index) => {
                const imgId = `img-check-${index}`;
                const isChecked = selectedNames.has(img.name);
                const imgHtml = `
                    <div class="btn-toggle">
                        <label for="${imgId}" class="flex items-start w-full">
                            <input type="checkbox" id="${imgId}" value="${index}" class="mt-1 h-5 w-5 text-orange-600 border-gray-500 rounded focus:ring-orange-500" ${isChecked ? 'checked' : ''}>
                            <div class="ml-3">
                                <p class="font-semibold text-lg text-orange-400">${img.name}</p>
                                <p class="text-sm text-gray-400">${img.reasoning}</p>
                            </div>
                        </label>
                    </div>
                `;
                container.innerHTML += imgHtml;
            });
        }

        function renderMedicationList() {
            const container = document.getElementById('medication-list-container');
            container.innerHTML = '';
            const recommendedMeds = intakeState.recommendedMeds;
            const selectedNames = new Set(intakeState.selectedMeds.map(item => item.name));

            if (!recommendedMeds || recommendedMeds.length === 0) {
                noMedsMessage.classList.remove('hidden');
                return;
            }
            
            noMedsMessage.classList.add('hidden');

            const groupedMeds = recommendedMeds.reduce((acc, med) => {
                const line = med.line || 'Other';
                if (!acc[line]) {
                    acc[line] = [];
                }
                acc[line].push(med);
                return acc;
            }, {});

            const lineOrder = ['1st Line', '2nd Line', '3rd Line', 'Other'];

            lineOrder.forEach(line => {
                if (groupedMeds[line]) {
                    container.innerHTML += `<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">${line}</h3>`;
                    
                    groupedMeds[line].forEach((med, index) => {
                        const medId = `med-check-${line}-${index}`;
                        const isChecked = selectedNames.has(med.name);
                        const originalIndex = intakeState.recommendedMeds.findIndex(m => m.name === med.name && m.line === med.line);

                        const medHtml = `
                            <div class="btn-toggle">
                                <label for="${medId}" class="flex items-start w-full">
                                    <input type="checkbox" id="${medId}" value="${originalIndex}" class="mt-1 h-5 w-5 text-orange-600 border-gray-500 rounded focus:ring-orange-500" ${isChecked ? 'checked' : ''}>
                                    <div class="ml-3">
                                        <p class="font-semibold text-lg text-orange-400">${med.name} ${med.dosage} (${med.type})</p>
                                        <p class="text-sm text-gray-400">${med.reasoning}</p>
                                    </div>
                                </label>
                            </div>
                        `;
                        container.innerHTML += medHtml;
                    });
                }
            });
        }

        function renderConsultsList() {
            const container = document.getElementById('consults-list-container');
            container.innerHTML = '';
            const { recommendedConsults, recommendedEducation } = intakeState;

            const selectedConsultNames = new Set(intakeState.selectedConsults.map(item => item.name));
            const selectedEduTopics = new Set(intakeState.selectedEducation.map(item => item.topic));

            let hasContent = false;

            if (recommendedConsults && recommendedConsults.length > 0) {
                hasContent = true;
                container.innerHTML += '<h3 class="text-lg font-semibold mb-2 text-gray-200">Consults</h3>';
                recommendedConsults.forEach((consult, index) => {
                    const consultId = `consult-check-${index}`;
                    const isChecked = selectedConsultNames.has(consult.name);
                    const consultHtml = `
                        <div class="btn-toggle">
                            <label for="${consultId}" class="flex items-start w-full">
                                <input type="checkbox" id="${consultId}" value="${index}" class="mt-1 h-5 w-5 text-orange-600 border-gray-500 rounded focus:ring-orange-500" ${isChecked ? 'checked' : ''}>
                                <div class="ml-3">
                                    <p class="font-semibold text-lg text-orange-400">${consult.name}</p>
                                    <p class="text-sm text-gray-400">${consult.reasoning}</p>
                                </div>
                            </label>
                        </div>
                    `;
                    container.innerHTML += consultHtml;
                });
            }
            
            if (recommendedEducation && recommendedEducation.length > 0) {
                hasContent = true;
                container.innerHTML += '<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">Patient Education</h3>';
                recommendedEducation.forEach((edu, index) => {
                    const eduId = `edu-check-${index}`;
                    const isChecked = selectedEduTopics.has(edu.topic);
                    const eduHtml = `
                        <div class="btn-toggle">
                            <label for="${eduId}" class="flex items-start w-full">
                                <input type="checkbox" id="${eduId}" value="${index}" class="mt-1 h-5 w-5 text-orange-600 border-gray-500 rounded focus:ring-orange-500" ${isChecked ? 'checked' : ''}>
                                <div class="ml-3">
                                    <p class="font-semibold text-lg text-orange-400">${edu.topic}</p>
                                    <p class="text-sm text-gray-400">${edu.reasoning}</p>
                                </div>
                            </label>
                        </div>
                    `;
                    container.innerHTML += eduHtml;
                });
            }

            if (!hasContent) {
                noConsultsMessage.classList.remove('hidden');
            } else {
                noConsultsMessage.classList.add('hidden');
            }
        }

        function renderProfileRecommendations() {
            const container = document.getElementById('profile-recommendations-container');
            container.innerHTML = '';
            const profile = intakeState.recommendedProfile;

            const profileDays = intakeState.selectedProfileDays || profile.days || 0;
            const selectedLimitations = new Set(intakeState.selectedProfileLimitations);
            const selectedPtInfo = new Set(intakeState.selectedProfilePatientInfo);

            if (!profile || (!profile.days && !profile.limitations && !profile.patientInfo)) {
                noProfileMessage.classList.remove('hidden');
                return;
            }
            
            noProfileMessage.classList.add('hidden');
            
            let profileHtml = '';

            profileHtml += `
                <div>
                    <label for="profile-days-input" class="block text-sm font-medium text-gray-300 mb-1">Recommended Profile Duration (Days):</label>
                    <input type="number" id="profile-days-input" class="w-24 p-2 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white" value="${profileDays}">
                </div>
            `;

            if (profile.limitations && profile.limitations.length > 0) {
                profileHtml += '<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">Military Limitations</h3>';
                profile.limitations.forEach((item, index) => {
                    const itemId = `limitation-check-${index}`;
                    const isChecked = selectedLimitations.has(item);
                    profileHtml += `
                        <div class="btn-toggle">
                            <label for="${itemId}" class="flex items-start w-full">
                                <input type="checkbox" id="${itemId}" value="${item}" class="mt-1 h-5 w-5 text-orange-600 border-gray-500 rounded focus:ring-orange-500" ${isChecked ? 'checked' : ''}>
                                <span class="ml-3 text-sm text-gray-300">${item}</span>
                            </label>
                        </div>
                    `;
                });
            }
            
            if (profile.patientInfo && profile.patientInfo.length > 0) {
                profileHtml += '<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">Patient Information / Education</h3>';
                profile.patientInfo.forEach((item, index) => {
                    const itemId = `pt-info-check-${index}`;
                    const isChecked = selectedPtInfo.has(item);
                    profileHtml += `
                        <div class="btn-toggle">
                            <label for="${itemId}" class="flex items-start w-full">
                                <input type="checkbox" id="${itemId}" value="${item}" class="mt-1 h-5 w-5 text-orange-600 border-gray-500 rounded focus:ring-orange-500" ${isChecked ? 'checked' : ''}>
                                <span class="ml-3 text-sm text-gray-300">${item}</span>
                            </label>
                        </div>
                    `;
                });
            }

            container.innerHTML = profileHtml;
        }


        // --- API Call Logic ---

        /**
         * Main function to call the Gemini API with exponential backoff.
         * @param {string} systemPrompt - The system instruction.
         * @param {string} userQuery - The user's prompt.
         * @param {string} step - A string identifier for the current step to route the response.
         * @param {number} [retries=3] - Number of retries left.
         * @param {number} [delay=1000] - Initial delay in ms.
         */
        async function callGeminiApi(systemPrompt, userQuery, step, retries = 3, delay = 1000) {
            
            // --- UPDATED: Hard-coded API key ---
            // PASTE YOUR NEW, PRIVATE API KEY HERE
            const apiKey = "AIzaSyDz8uUjnzjhpG8BeUlZIB_HuwdhMhAh39g"; 
            // ---------------------------------

            if (apiKey === "AIzaSyDz8uUjnzjhpG8BeUlZIB_HuwdhMhAh39g") {
                showErrorMessage('symptoms', 'API Key is missing. Please edit the .html file and add your API key to the "apiKey" variable in the script.');
                showSection('symptoms');
                return;
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: getResponseSchemaForStep(step)
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if ((response.status === 429 || response.status >= 500) && retries > 0) {
                        console.warn(`API Error ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiApi(systemPrompt, userQuery, step, retries - 1, delay * 2);
                    }
                    // REMOVED: 400 error check for bad key
                    const errorBody = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorBody}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    processApiResponse(step, parsedJson);
                } else if (result.candidates && result.candidates[0].finishReason) {
                    throw new Error(`API call finished with reason: ${result.candidates[0].finishReason}. No content returned.`);
                } else {
                    console.error("Invalid API response structure:", result);
                    throw new Error("Invalid API response structure. Check console for details.");
                }

            } catch (error) {
                console.error("Error during API call:", error);
                
                let errorSectionId = 'symptoms';
                if (step === 'step1-questions') errorSectionId = 'symptoms';
                if (step === 'step2-plan') errorSectionId = 'history';

                showErrorMessage(errorSectionId, `Error: ${error.message}. Please try again.`);
                showLoading(false);
                showSection(errorSectionId);
            }
        }

        /**
         * Returns the JSON schema for the expected API response based on the current step.
         */
        function getResponseSchemaForStep(step) {
            const commonStringArray = { type: "ARRAY", items: { type: "STRING" } };
            const commonNameReasoningArray = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        name: { type: "STRING" },
                        reasoning: { type: "STRING" }
                    },
                    required: ["name", "reasoning"]
                }
            };

            const comprehensiveMedsSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        name: { type: "STRING" },
                        dosage: { type: "STRING" },
                        line: { type: "STRING", enum: ["1st Line", "2nd Line", "3rd Line"] },
                        type: { type: "STRING", enum: ["Timed", "PRN", "Preventative"] },
                        reasoning: { type: "STRING" }
                    },
                    required: ["name", "dosage", "line", "type", "reasoning"]
                }
            };


            switch (step) {
                case 'step1-questions':
                    return {
                        type: "OBJECT",
                        properties: {
                            questions: commonStringArray
                        },
                        required: ["questions"]
                    };
                
                case 'step2-plan':
                    return {
                        type: "OBJECT",
                        properties: {
                            hpi: { type: "STRING" },
                            assessmentAndPlan: { type: "STRING" },
                            emergencyTriage: {
                                type: "OBJECT",
                                properties: {
                                    isEmergency: { type: "BOOLEAN" },
                                    reasoning: { type: "STRING" }
                                },
                                required: ["isEmergency", "reasoning"]
                            },
                            recommendedImaging: commonNameReasoningArray,
                            recommendedMeds: comprehensiveMedsSchema,
                            recommendedConsults: commonNameReasoningArray,
                            recommendedEducation: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        topic: { type: "STRING" },
                                        reasoning: { type: "STRING" }
                                    },
                                    required: ["topic", "reasoning"]
                                }
                            },
                            recommendedProfile: {
                                "type": "OBJECT",
                                "properties": {
                                    "days": { "type": "NUMBER" },
                                    "limitations": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "patientInfo": { "type": "ARRAY", "items": { "type": "STRING" } }
                                },
                                "required": ["days", "limitations", "patientInfo"]
                            }
                        },
                        required: ["hpi", "assessmentAndPlan", "emergencyTriage", "recommendedImaging", "recommendedMeds", "recommendedConsults", "recommendedEducation", "recommendedProfile"]
                    };
                
                default:
                    return { 
                        type: "OBJECT",
                        properties: {
                            error: { type: "STRING" }
                        }
                    };
            }
        }

        /**
         * Processes the structured JSON response from the API.
         */
        function processApiResponse(step, data) {
            try {
                switch (step) {
                    case 'step1-questions':
                        if (!data.questions) throw new Error("API response missing 'questions' field.");
                        intakeState.questions = data.questions;
                        renderQuestions(data.questions);
                        showSection('questions');
                        break;
                    
                    case 'step2-plan':
                        const requiredFields = ['hpi', 'assessmentAndPlan', 'emergencyTriage', 'recommendedImaging', 'recommendedMeds', 'recommendedConsults', 'recommendedEducation', 'recommendedProfile'];
                        for (const field of requiredFields) {
                            if (data[field] === undefined) {
                                throw new Error(`API response missing required field: '${field}'`);
                            }
                        }

                        // Store all data in state
                        intakeState.hpi = data.hpi;
                        intakeState.assessmentAndPlan = data.assessmentAndPlan;
                        intakeState.emergencyTriage = data.emergencyTriage;
                        intakeState.recommendedImaging = data.recommendedImaging;
                        intakeState.recommendedMeds = data.recommendedMeds;
                        intakeState.recommendedConsults = data.recommendedConsults;
                        intakeState.recommendedEducation = data.recommendedEducation;
                        intakeState.recommendedProfile = data.recommendedProfile;

                        // Reset selected items from previous runs
                        intakeState.selectedImaging = [];
                        intakeState.selectedMeds = [];
                        intakeState.selectedConsults = [];
                        intakeState.selectedEducation = [];
                        intakeState.selectedProfileDays = 0;
                        intakeState.selectedProfileLimitations = [];
                        intakeState.selectedProfilePatientInfo = [];

                        if (data.emergencyTriage && data.emergencyTriage.isEmergency) {
                            emergencyReason.textContent = data.emergencyTriage.reasoning;
                            emergencyAlert.classList.remove('hidden');
                        } else {
                            emergencyAlert.classList.add('hidden');
                        }
                        
                        renderImagingList();
                        renderMedicationList();
                        renderConsultsList();
                        renderProfileRecommendations();
                        
                        showSection('imaging');
                        break;
                }
            } catch (error) {
                console.error("Error processing API response:", error, data);
                let errorSectionId = 'symptoms';
                if (step === 'step1-questions') errorSectionId = 'symptoms';
                if (step === 'step2-plan') errorSectionId = 'history';
                
                showErrorMessage(errorSectionId, `Error processing data: ${error.message}`);
                showSection(errorSectionId);
            }
        }


        // --- Event Listeners ---

        symptomForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const complaint = initialSymptomsEl.value;
            if (complaint.trim().length < 10) {
                showErrorMessage('symptoms', 'Please enter a more detailed chief complaint.');
                return;
            }
            showLoading(true);
            
            intakeState.chiefComplaint = complaint;

            const systemPrompt = `
You are an expert AI clinical assistant for a combat medic. Your role is to generate **only** a structured JSON output.
The medic has provided a de-identified chief complaint.
Your task is to generate 5-7 critical, open-ended follow-up questions to build an HPI (History of Present Illness).
Focus on OPQRST (Onset, Palliative/Provocative, Quality, Radiation, Severity, Timing) and associated symptoms.
Do not ask for PHI (e.g., "What is your name?").
Do not ask questions that are answered in the chief complaint.
Return a JSON object matching this schema:
{
  "type": "OBJECT",
  "properties": { "questions": { "type": "ARRAY", "items": { "type": "STRING" } } },
  "required": ["questions"]
}
`;
            const userQuery = `Chief Complaint: "${intakeState.chiefComplaint}"`;
            
            callGeminiApi(systemPrompt, userQuery, 'step1-questions');
        });

        exampleComplaintBtn.addEventListener('click', (e) => {
            e.preventDefault();
            initialSymptomsEl.value = "20ish soldier with lower back pain for one week after a heavy lift. Describes pain as a dull ache, 6/10 severity, radiating to the right buttock. Worse with bending, better with rest. No numbness or weakness.";
        });


        questionsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            intakeState.answers = [];
            const inputs = questionsContainer.querySelectorAll('input[type="text"]');
            
            let allAnswered = true;
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    allAnswered = false;
                }
                intakeState.answers.push({
                    question: input.dataset.question,
                    answer: input.value
                });
            });

            if (!allAnswered) {
                showErrorMessage('questions', 'Please answer all questions before proceeding.');
                return;
            }
            
            pmhInput.value = intakeState.pastMedicalHistory;
            allergiesInput.value = intakeState.allergies;
            medsInput.value = intakeState.currentMedications;

            showSection('history');
        });

        questionsBackBtn.addEventListener('click', () => showSection('symptoms'));

        historyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading(true);

            intakeState.pastMedicalHistory = pmhInput.value.trim();
            intakeState.allergies = allergiesInput.value.trim();
            intakeState.currentMedications = medsInput.value.trim();

            let fullHpiContext = `Chief Complaint: ${intakeState.chiefComplaint}\n`;
            intakeState.answers.forEach(qa => {
                fullHpiContext += `Q: ${qa.question}\nA: ${qa.answer}\n`;
            });

            // --- UPDATED: New system prompt with 6-med minimum ---
            const systemPrompt = `
You are an expert AI clinical assistant for a combat medic. Your role is to generate **only** a structured JSON output.
The medic has provided a full HPI and Patient History.
Your task is to:
1.  Synthesize the HPI into a single, concise paragraph.
2.  Write a brief Assessment & Plan (A&P), including differential diagnoses (DDx) and rationale.
3.  Determine if this is an "emergencyTriage" case (e.g., requires immediate ER, red flags like cauda equina syndrome).
4.  Recommend "recommendedImaging". Be specific about body part and view (e.g., 'X-Ray L-Spine 2-view', 'MRI L-Spine w/o contrast').
5.  Recommend a comprehensive list of "recommendedMeds".
    -   You **MUST** provide a list of at least six (6) medications.
    -   This list **MUST** contain at least two (2) '1st Line', two (2) '2nd Line', and two (2) '3rd Line' options.
    -   Each medication must have a "name", "dosage", "reasoning", "line" ('1st Line', '2nd Line', or '3rd Line'), and "type" ('Timed', 'PRN', or 'Preventative').
    -   **Incorporate allergies and current meds into this logic.**
6.  Recommend "recommendedConsults" (e.g., Physical Therapy, Ortho) with reasoning.
7.  Recommend "recommendedEducation" topics (e.g., stretching, warning signs) with reasoning.
8.  Provide "recommendedProfile" containing "days" (number), "limitations" (array of strings for commander), and "patientInfo" (array of strings for patient education).
If no items are needed for a list, return an empty array [].
Return a JSON object matching the schema defined in 'getResponseSchemaForStep("step2-plan")'.
`;
            const userQuery = `
Full HPI Context:
${fullHpiContext}

Patient History:
Past Medical History: ${intakeState.pastMedicalHistory || 'None provided'}
Allergies: ${intakeState.allergies || 'None provided'}
Current Medications: ${intakeState.currentMedications || 'None provided'}
`;

            callGeminiApi(systemPrompt, userQuery, 'step2-plan');
        });

        historyBackBtn.addEventListener('click', () => {
            intakeState.pastMedicalHistory = pmhInput.value.trim();
            intakeState.allergies = allergiesInput.value.trim();
            intakeState.currentMedications = medsInput.value.trim();
            showSection('questions');
        });


        imagingContinueBtn.addEventListener('click', () => {
            intakeState.selectedImaging = [];
            const checkboxes = imagingListContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedImaging.push(intakeState.recommendedImaging[index]);
            });
            showSection('medication');
        });

        imagingBackBtn.addEventListener('click', () => {
            intakeState.selectedImaging = [];
            const checkboxes = imagingListContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedImaging.push(intakeState.recommendedImaging[index]);
            });
            showSection('history');
        });

        medicationContinueBtn.addEventListener('click', () => {
            intakeState.selectedMeds = [];
            const checkboxes = medicationListContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedMeds.push(intakeState.recommendedMeds[index]);
            });
            showSection('consults');
        });

        medicationBackBtn.addEventListener('click', () => {
            intakeState.selectedMeds = [];
            const checkboxes = medicationListContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedMeds.push(intakeState.recommendedMeds[index]);
            });
            showSection('imaging');
        });

        consultsContinueBtn.addEventListener('click', () => {
            intakeState.selectedConsults = [];
            const consultCheckboxes = consultsListContainer.querySelectorAll('input[id^="consult-check-"]:checked');
            consultCheckboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedConsults.push(intakeState.recommendedConsults[index]);
            });

            intakeState.selectedEducation = [];
            const eduCheckboxes = consultsListContainer.querySelectorAll('input[id^="edu-check-"]:checked');
            eduCheckboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedEducation.push(intakeState.recommendedEducation[index]);
            });

            showSection('profile');
        });

        consultsBackBtn.addEventListener('click', () => {
            intakeState.selectedConsults = [];
            const consultCheckboxes = consultsListContainer.querySelectorAll('input[id^="consult-check-"]:checked');
            consultCheckboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedConsults.push(intakeState.recommendedConsults[index]);
            });
            intakeState.selectedEducation = [];
            const eduCheckboxes = consultsListContainer.querySelectorAll('input[id^="edu-check-"]:checked');
            eduCheckboxes.forEach(cb => {
                const index = parseInt(cb.value, 10);
                intakeState.selectedEducation.push(intakeState.recommendedEducation[index]);
            });
            showSection('medication');
        });

        profileContinueBtn.addEventListener('click', () => {
            const daysInput = document.getElementById('profile-days-input');
            if (!daysInput) {
                intakeState.selectedProfileDays = 0;
                intakeState.selectedProfileLimitations = [];
                intakeState.selectedProfilePatientInfo = [];
            } else {
                intakeState.selectedProfileDays = parseInt(daysInput.value, 10) || 0;

                intakeState.selectedProfileLimitations = [];
                const limitationCheckboxes = profileRecommendationsContainer.querySelectorAll('input[id^="limitation-check-"]:checked');
                limitationCheckboxes.forEach(cb => {
                    intakeState.selectedProfileLimitations.push(cb.value);
                });

                intakeState.selectedProfilePatientInfo = [];
                const ptInfoCheckboxes = profileRecommendationsContainer.querySelectorAll('input[id^"pt-info-check-"]:checked');
                ptInfoCheckboxes.forEach(cb => {
                    intakeState.selectedProfilePatientInfo.push(cb.value);
                });
            }

            showFinalNote();
            showSection('providerNote');
        });

        profileBackBtn.addEventListener('click', () => {
            const daysInput = document.getElementById('profile-days-input');
            if (daysInput) {
                intakeState.selectedProfileDays = parseInt(daysInput.value, 10) || 0;
            }
            intakeState.selectedProfileLimitations = [];
            const limitationCheckboxes = profileRecommendationsContainer.querySelectorAll('input[id^="limitation-check-"]:checked');
            limitationCheckboxes.forEach(cb => {
                intakeState.selectedProfileLimitations.push(cb.value);
            });
            intakeState.selectedProfilePatientInfo = [];
            const ptInfoCheckboxes = profileRecommendationsContainer.querySelectorAll('input[id^"pt-info-check-"]:checked');
            ptInfoCheckboxes.forEach(cb => {
                intakeState.selectedProfilePatientInfo.push(cb.value);
            });
            showSection('consults');
        });


        function showFinalNote() {
            let finalNote = "MEDIC-SELECTED PLAN (DE-IDENTIFIED):\n";
            finalNote += "====================================\n";
            
            if (intakeState.selectedImaging.length > 0) {
                finalNote += "--- IMAGING ---\n";
                intakeState.selectedImaging.forEach(item => finalNote += `- ${item.name}\n`);
            } else {
                finalNote += "--- IMAGING ---\n- None selected.\n";
            }

            if (intakeState.selectedMeds.length > 0) {
                finalNote += "\n--- MEDICATIONS ---\n";
                intakeState.selectedMeds.forEach(item => finalNote += `- ${item.name} ${item.dosage} (${item.type})\n`);
            } else {
                finalNote += "\n--- MEDICATIONS ---\n- None selected.\n";
            }
            
            if (intakeState.selectedConsults.length > 0) {
                finalNote += "\n--- CONSULTS ---\n";
                intakeState.selectedConsults.forEach(item => finalNote += `- ${item.name}\n`);
            } else {
                finalNote += "\n--- CONSULTS ---\n- None selected.\n";
            }

            if (intakeState.selectedEducation.length > 0) {
                finalNote += "\n--- PATIENT EDUCATION ---\n";
                intakeState.selectedEducation.forEach(item => finalNote += `- ${item.topic}\n`);
            } else {
                finalNote += "\n--- PATIENT EDUCATION ---\n- None selected.\n";
            }

            finalNote += "\n\nMEDIC-SELECTED PROFILE RECOMMENDATIONS:\n";
            finalNote += "========================================\n";
            finalNote += `--- DURATION ---\n- ${intakeState.selectedProfileDays} days\n`;
            
            if (intakeState.selectedProfileLimitations.length > 0) {
                finalNote += "\n--- LIMITATIONS (FOR COMMANDER) ---\n";
                intakeState.selectedProfileLimitations.forEach(item => finalNote += `- ${item}\n`);
            } else {
                finalNote += "\n--- LIMITATIONS (FOR COMMANDER) ---\n- None selected.\n";
            }

            if (intakeState.selectedProfilePatientInfo.length > 0) {
                finalNote += "\n--- PATIENT INFORMATION ---\n";
                intakeState.selectedProfilePatientInfo.forEach(item => finalNote += `- ${item}\n`);
            } else {
                finalNote += "\n--- PATIENT INFORMATION ---\n- None selected.\n";
            }
            
            finalNote += "\n\nAI-GENERATED FIELD NOTE (DE-IDENTIFIED):\n";
            finalNote += "========================================\n";
            
            finalNote += "HISTORY OF PRESENT ILLNESS (AI-GENERATED):\n";
            finalNote += `${intakeState.hpi}\n`;

            finalNote += "\nPATIENT-PROVIDED HISTORY:\n";
            finalNote += `Past Medical History: ${intakeState.pastMedicalHistory || 'None'}\n`;
            finalNote += `Allergies: ${intakeState.allergies || 'None'}\n`;
            finalNote += `Current Medications: ${intakeState.currentMedications || 'None'}\n`;
            finalNote += "\n";

            finalNote += "ASSESSMENT & PLAN (AI-GENERATED):\n";
            finalNote += `${intakeState.assessmentAndPlan}\n`;

            providerNoteContent.textContent = finalNote;
        }

        function copyToClipboard(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                copySuccess.classList.remove('hidden');
                setTimeout(() => copySuccess.classList.add('hidden'), 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showErrorMessage('providerNote', 'Failed to copy text. Please copy manually.');
            }
            document.body.removeChild(ta);
        }

        copyNoteBtn.addEventListener('click', () => {
            copyToClipboard(providerNoteContent.textContent);
        });

        noteBackBtn.addEventListener('click', () => showSection('profile'));

        function startOver() {
            intakeState = {
                chiefComplaint: "",
                questions: [],
                answers: [],
                pastMedicalHistory: "",
                allergies: "",
                currentMedications: "",
                hpi: "",
                assessmentAndPlan: "",
                emergencyTriage: null,
                recommendedImaging: [],
                recommendedMeds: [],
                recommendedConsults: [],
                recommendedEducation: [],
                recommendedProfile: {},
                selectedImaging: [],
                selectedMeds: [],
                selectedConsults: [],
                selectedEducation: [],
                selectedProfileDays: 0,
                selectedProfileLimitations: [],
                selectedProfilePatientInfo: []
            };

            // Clear inputs and containers
            initialSymptomsEl.value = '';
            questionsContainer.innerHTML = '';
            pmhInput.value = '';
            allergiesInput.value = '';
            medsInput.value = '';
            imagingListContainer.innerHTML = '';
            medicationListContainer.innerHTML = '';
            consultsListContainer.innerHTML = '';
            profileRecommendationsContainer.innerHTML = '';
            providerNoteContent.textContent = '';
            emergencyAlert.classList.add('hidden');
            copySuccess.classList.add('hidden');
            clearErrors();

            // Show first section
            showSection('symptoms');
        }

        startOverBtn.addEventListener('click', startOver);

        // --- Initial Load ---
        // UPDATED: Show the first section by default
        showSection('symptoms');

    </script>

</body>
</html>

